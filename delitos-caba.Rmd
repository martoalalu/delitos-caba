---
title: "Distribución espacial de delitos"
author: "Marto"
date: "18/12/2019"
output:
  html_document: 
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
```

## Delitos en la Ciudad de Buenos Aires

En consonancia con la [política de datos abiertos](http://rpubs.com/martinalalu/centralidades-comerciales) la Ciudad de Buenos Aires comenzó a publicar información desagregada sobre distintos tipos de delitos en el [Mapa del Delito](https://mapa.seguridadciudad.gob.ar/). Los datos disponibles abarcan el período 2016-2018. Cabe hacer la aclaración que se tratan de delitos efectivamente denunciados y por los cuales se inició un expediente.

El objetivo del presente trabajo será analizar la distribución espacial de los delitos en la Ciudad pudiendo identificar cómo éstos variaron (o no) a lo largo de los años, si hay diferencia entre los distintos tipos y barrios. Por último se llevará a cabo un [Test I de Moran](https://es.wikipedia.org/wiki/I_de_Moran) para poder medir la autocorrelación espacial de los delitos, es decir si su distribución es producto del azar o no; y por último se realizará un modelo de regersión simple para modelar la relación de los delitos con la distancia a las comisarías (en tanto elementos que teóricamente deberían disuadir la ocurrencia de delitos).

Los datos fueron scrapeados del [Mapa del Delito](https://mapa.seguridadciudad.gob.ar/) y preprocesados para poder confeccionar el análisis.


```{r}
library(data.table)
library(tidyverse)
library(sf)
library(ggplot2)
library(dplyr)
library(viridis)
library(data.table)
library(ggmap)
library(janitor)
library(ggdark)
library(leaflet)
library(lubridate)


delitos <- fread("https://raw.githubusercontent.com/martoalalu/delitos-caba/master/data/delitos.csv",encoding = 'UTF-8')

barrios_replace<- c("COGHLAND", "LA BOCA", "VILLA GRAL MITRE", "MONTSERRAT")

delitos <- delitos %>% 
  mutate(fecha=ymd(fecha)) %>% 
  mutate(anio=year(fecha)) %>% 
  mutate(anio_mes = floor_date(as_date(fecha), "month")) %>% 
  mutate(barrio = case_when(grepl(paste(barrios_replace[1]), barrio) ~ "COGHLAN",
                                 grepl(paste(barrios_replace[2]), barrio) ~ "BOCA",
                                 grepl(paste(barrios_replace[3]), barrio) ~ "VILLA GRAL. MITRE",
                                 grepl(paste(barrios_replace[4]), barrio) ~ "MONSERRAT",
                                 TRUE~barrio))

nrow(delitos)/(365*3)

delitos %>% 
  count(anio) %>% 
  mutate(pct=(n/sum(n))*100)


delitos %>% 
  ggplot(aes(anio))+
    geom_bar(aes(fill=as.factor(tipo_delito)))+
  labs(title="Distribución de delitos por año (2016-2018)",
       subtitle="Ciudad Autónoma de Buenos Aires",
       caption= "Fuente de datos: https://https://mapa.seguridadciudad.gob.ar/",
       fill="Tipo de delito")
```

En los 3 años se cometieron **350980 delitos**, un promedio de **320 por día**, mientras que la distribución en este período es bastante pareja, con un 33.5% en 2016, 34.3% en 2017 y 32.1% en 2018. Mientras que en cuanto a los tipos de delito tampoco hay grandes variaciones, con amplia predominancia de **Robo con violencia** y **Hurto sin violencia**, la irrupción de **Lesiones en seguridad vial** en 2017 se explica únicamente porque es el único período con datos de ese tipo de delito.

```{r}
delitos %>% 
  count(anio_mes,tipo_delito) %>% 
  ggplot() +
  geom_line(aes(x=anio_mes, y=n, color=tipo_delito))+
  xlab("")+
  labs(title="Distribución de delitos por mes (2016-2018)",
       subtitle="Ciudad Autónoma de Buenos Aires",
       caption= "Fuente de datos: https://https://mapa.seguridadciudad.gob.ar/",
       fill="Tipo de delito")

```

En términos generales no se observan grandes variaciones a lo largo del período, la cantidad de delitos se mantiene a pesar de las fluctiaciones durante el año. A fines prácticos en el presente trabajo nos concentraremos en los dos principales delitos de este período, **Robo (Con violencia) con 200374 hechos** y **Hurto (Sin violencia) con 112301 hechos**,los cuales **concentran el 89% del total de los delitos** en el período analizado.

# Distribución espacial

Veamos cómo fue la distribución espacial de estos delitos a lo largo de los 3 años.

```{r}
#Creamos df con delitos de robo y hurto que tengan coordenadas
delitos_geo <- delitos %>% 
  filter(!is.na(longitud), !is.na(latitud)) %>%
  filter(longitud != 0) %>%
  filter(tipo_delito=="Robo (Con violencia)" | tipo_delito=="Hurto (Sin violencia)") %>% 
  st_as_sf(coords = c("longitud", "latitud"), crs = 4326)

#Nos quedamos solo con los delitos ocurridos en la Ciudad de Buenos Aires
radios <- read_sf("http://cdn.buenosaires.gob.ar/datosabiertos/datasets/informacion-censal-por-radio/caba_radios_censales.geojson")

delitos_caba <- delitos_geo[st_within(delitos_geo, radios) %>% lengths > 0,]
delitos_caba<- delitos_caba %>% 
  mutate(long=st_coordinates(delitos_caba)[,1],
         lat=st_coordinates(delitos_caba)[,2])

bbox <- c(-58.546686, 
          -34.711145,
          -58.329097,
          -34.529156)

CABA <- get_stamenmap(bbox = bbox, 
                      maptype = "toner-lite",
                      zoom=13)


ggmap(CABA) +
  stat_density_2d(data = filter(delitos_caba,tipo_delito=="Robo (Con violencia)"), 
                  aes(x = long, y = lat, 
                      fill = stat(level)), alpha = 0.6, geom = "polygon") +
  labs(title="Distribución de Robo (con violencia) 2016-2018",
       subtitle="Ciudad Autónoma de Buenos Aires",
       x="",
       y="",
       caption= "Fuente de datos: https://mapa.seguridadciudad.gob.ar/",
       fill="Nivel")+
  scale_fill_distiller(palette = "Spectral")+
  theme_void()+
  facet_wrap(~anio)

ggmap(CABA) +
  stat_density_2d(data = filter(delitos_caba,tipo_delito=="Hurto (Sin violencia)"), 
                  aes(x = long, y = lat, 
                      fill = stat(level)), alpha = 0.6, geom = "polygon") +
  labs(title="Distribución de Hurto (sin violencia) 2016-2018",
       subtitle="Ciudad Autónoma de Buenos Aires",
       x="",
       y="",
       caption= "Fuente de datos: https://mapa.seguridadciudad.gob.ar/",
       fill="Nivel")+
  scale_fill_distiller(palette = "Spectral")+
  theme_void()+
  facet_wrap(~anio)


```

Luego del filtro nos quedamos con un total de 308500 delitos.
A partir del mapa de densidad podemos ver cómo a grandes rasgos la concentración de estos dos tipos de delitos. 
El delito "Robo (con violencia)" parece ocurrir prácticamente que en toda la Ciudad y relativamente pareja a lo largo de los tres años. Once, Constitución y el Obelisco, en ese orden, emergen como las zonas más calientes de este tipo de delito. En 2016 fue particularmente alta la concentración de robos con violencia en Once, para luego ser desplazada por Constitución en 2017 y retomar el liderazgo en 2018. Las zonas cercanas a la Estación Flores y Belgrano (Cabildo y Juramento) emergen como zonas secundarias también donde predominan este tipo de delitos.

A diferencia del delito anterior "Hurto (sin violencia)" no tiene una distribución homogenea a lo largo del territorio de la Ciudad, sino que es posible ver cómo la zona del Obelisco y Once (Pueyrredón y Corrientes / Rivadavia) va perdiendo protagonismo y el Obelisco gana espacio luego de una leve caída en 2017. Los corredores de las avenidas Rivadavia y Cabildo/Santa Fe parecen marcar un patrón claro, algo esperable por la elevada cantidad de gente que transita por esas calles. En línea con esto último las centralidades de Flores (Rivadavia y Carabobo) y Belgrano (Cabildo y Juramento) se resaltan levemente, al igual que lo identificado con el robo con violencia.

## Barrios

Sigamos viendo patrones espaciales agregando los datos a nivel barrio.

```{r}

#Poblacion por barrio
barrios <- radios %>% 
  group_by(BARRIO) %>%
  summarise(poblacion_barrio=sum(POBLACION)) %>% 
  clean_names()

#Mapeamos poblacion
ggplot() +
  geom_sf(data = barrios, aes(fill = poblacion_barrio), color = NA) +
  labs(title = "Poblacion por Barrio",
       subtitle="Ciudad Autónoma de Buenos Aires",
       fill = "Cantidad",
       caption= "Fuente de datos: https://mapa.seguridadciudad.gob.ar/")+
  scale_fill_viridis_c(alpha = 0.9)

delitos_caba_geo <- delitos_caba
st_geometry(delitos_caba) <- NULL

#Delitos por barrio
delitos_barrio <- delitos_caba %>% 
  group_by(barrio, tipo_delito, anio) %>%
  summarise(cant_delitos=n())

delitos_barrio_robo <- filter(delitos_barrio, tipo_delito=="Robo (Con violencia)")
delitos_barrio_hurto <- filter(delitos_barrio, tipo_delito=="Hurto (Sin violencia)")

ggpubr::ggarrange(ncol=3, nrow=1,
  barrios %>% 
  left_join(filter(delitos_barrio_robo, anio==2016)) %>% 
  mutate(delitos_hab=cant_delitos/poblacion_barrio) %>% 
  ggplot() +
  geom_sf(aes(fill = delitos_hab), color = NA) +
  labs(title = "Robos 2016",
       subtitle="CABA")+
  scale_fill_viridis_c(alpha = 0.9)+
  theme_void()+
  guides(fill=FALSE)
  ,
  
  barrios %>% 
    left_join(filter(delitos_barrio_robo, anio==2017)) %>% 
    mutate(delitos_hab=cant_delitos/poblacion_barrio) %>% 
    ggplot() +
    geom_sf(aes(fill = delitos_hab), color = NA) +
    labs(title = "Robos 2017",
         subtitle="CABA")+
    scale_fill_viridis_c(alpha = 0.9)+
    theme_void()+
    guides(fill=FALSE),
  
  barrios %>% 
    left_join(filter(delitos_barrio_robo, anio==2018)) %>% 
    mutate(delitos_hab=cant_delitos/poblacion_barrio) %>% 
    ggplot() +
    geom_sf(aes(fill = delitos_hab), color = NA) +
    labs(title = "Robos 2018",
         subtitle="CABA")+
    scale_fill_viridis_c(alpha = 0.9)+
    theme_void()+
    guides(fill=FALSE)
)

ggpubr::ggarrange(ncol=3, nrow=1,
  barrios %>% 
  left_join(filter(delitos_barrio_hurto, anio==2016)) %>% 
  mutate(delitos_hab=cant_delitos/poblacion_barrio) %>% 
  ggplot() +
  geom_sf(aes(fill = delitos_hab), color = NA) +
  labs(title = "Hurtos 2016",
       subtitle="CABA")+
  scale_fill_viridis_c(alpha = 0.9)+
  theme_void()+
  guides(fill=FALSE)
  ,
  
  barrios %>% 
    left_join(filter(delitos_barrio_hurto, anio==2017)) %>% 
    mutate(delitos_hab=cant_delitos/poblacion_barrio) %>% 
    ggplot() +
    geom_sf(aes(fill = delitos_hab), color = NA) +
    labs(title = "Hurto 2017",
         subtitle="CABA")+
    scale_fill_viridis_c(alpha = 0.9)+
    theme_void()+
    guides(fill=FALSE),
  
  barrios %>% 
    left_join(filter(delitos_barrio_hurto, anio==2018)) %>% 
    mutate(delitos_hab=cant_delitos/poblacion_barrio) %>% 
    ggplot() +
    geom_sf(aes(fill = delitos_hab), color = NA) +
    labs(title = "Hurto 2018",
         subtitle="CABA")+
    scale_fill_viridis_c(alpha = 0.9)+
    theme_void()+
    guides(fill=FALSE)
)

  

```

Al normalizar los delitos por la cantidad de habitantes de cada barrio vemos como en ambos casos San Nicolás es el barrio con mayores indices de inseguridad

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
barrios %>% 
  left_join(delitos_barrio_robo) %>% 
  mutate(delitos_hab=cant_delitos/poblacion_barrio) %>% 
  ggplot(aes(x=reorder(barrio, delitos_hab),
           y=delitos_hab,
           fill=factor(barrio)))+
  geom_bar(width=0.75,
           stat='identity',
           position='stack')+
  coord_flip() +
  labs(title = "Robos por cantidad de habitante",
       subtitle = "Ciudad Autónoma de Buenos Aires (2016-2019)",
       x = "Barrio",
       y = "Robos por habitante")+
  guides(fill=FALSE)

barrios %>% 
  left_join(delitos_barrio_hurto) %>% 
  mutate(delitos_hab=cant_delitos/poblacion_barrio) %>% 
  ggplot(aes(x=reorder(barrio, delitos_hab),
           y=delitos_hab,
           fill=factor(barrio)))+
  geom_bar(width=0.75,
           stat='identity',
           position='stack')+
  coord_flip() +
  labs(title = "Hurtos por cantidad de habitante",
       subtitle = "Ciudad Autónoma de Buenos Aires (2016-2019)",
       x = "Barrio",
       y = "Hurtos por habitante")+
  guides(fill=FALSE)
```

## Including Plots

You can also embed plots, for example:


Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
